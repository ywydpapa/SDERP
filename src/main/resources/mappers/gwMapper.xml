<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="gw">

<select id="listDoc" resultType="gwDto">
    select * from swc_businessdoc where attrib not like 'XXX%' and compNo = #{compNo};
 </select>

    <select id="detailDoc" resultType="gwDto">
        select * from swc_businessdoc where attrib not like 'XXX%' and compNo = #{compNo} and docNo=#{docNo};
    </select>

    <insert id="insertest">
	    <selectKey resultType="int" keyProperty="estVer" order="BEFORE">
				select IFNULL(MAX(estVer), 0)+1 from swc_est where estId = #{estId} and compNo = #{compNo}
	 	</selectKey>
	    insert into swc_est(
	    	estId,
	    	estVer,
	    	estTitle,
	    	custNo,
	    	soppNo,
	    	compNo,
	    	userNo,
	    	estAmount,
	    	estVat,
	    	estTotal,
	    	estDate,
	    	attrib
	    ) values (
	    	#{estId},
	    	#{estVer},
	    	#{estTitle},
	    	#{custNo},
	    	#{soppNo},
	    	#{compNo},
	    	#{userNo},
	    	#{estAmount},
	    	#{estVat},
	    	#{estTotal},
	    	#{estDate},
	        '10000'
	    );
    </insert>

    <insert id="insertestitems">
    	<selectKey resultType="int" keyProperty="estVer" order="BEFORE">
				select IFNULL(MAX(estVer), 0)+1 from swc_estitems where estId = #{estId} and compNo = #{compNo}
	 	</selectKey>
	    insert into swc_estitems(
	    	estId,
	    	estVer,
	    	custNo,
	    	compNo,
	    	productNo,
	    	productName,
	    	productSpec,
	    	productQty,
	    	productNetprice,
	    	productVat,
	    	productAmount,
	    	productDis,
	    	productTotal,
	    	productRemark,
	    	attrib
	    ) values (
	    	#{estId},
	    	#{estVer},
	    	#{custNo},
	    	#{compNo},
	    	#{productNo},
	    	#{productName},
	    	#{productSpec},
	    	#{productQty},
	    	#{productNetprice},
	    	#{productVat},
	    	#{productAmount},
	    	#{productDis},
	    	#{productTotal},
	    	#{productRemark},
	        '10000'
	    );
    </insert>

	<select id="listest" resultType="gwDto">
		select
			a.estNo
			 ,a.estId
			 ,max(a.estVer) estVer
			 ,a.estType
			 ,a.estTitle
			 ,a.estDesc
			 ,a.custNo
			 ,b.custName
			 ,a.soppNo
			 ,a.compNo
			 ,a.userNo
			 ,a.estAmount
			 ,a.estVat
			 ,a.estDiscount
			 ,a.estTotal
			 ,a.estDate
			 ,a.regDate
			 ,a.modDate
			 ,a.attrib
		from swc_est a
				 left join swc_cust b on a.custNo = b.custNo
		where a.attrib not like 'XXX%' group by a.estId;
	</select>

	<select id="detailest" resultType="gwDto">
		select a.*, b.custName, c.soppTitle from swc_est a LEFT JOIN swc_cust b ON a.custNo = b.custNo LEFT JOIN swc_sopp c ON a.soppNo = c.soppNo where a.estId=#{estId} limit 1;
	</select>

	<select id="listestitems" resultType="gwDto">
		select a.*, b.custName from swc_estitems a LEFT JOIN swc_cust b ON a.custNo = b.custNo where a.estId=#{estId} and a.estVer = #{estVer} and a.attrib not like 'XXX%';
	</select>

	<select id="listDoc" resultType="gwDto">
		select * from swc_businessdoc where attrib not like 'XXX%';
	</select>

	<select id="listMyDoc" resultType="gwDto">
		select * from swc_businessdoc where attrib not like 'XXX%' and docCrUserNo = #{docCrUserNo};
	</select>

	<select id="detailDoc" resultType="gwDto">
		select * from swc_businessdoc where docNo = #{docNo};
	</select>

	<insert id="insertDoc">
		insert into swc_businessdoc (
				docCrUserNo,
				docAppLvl,
				docType,
				docTitle,
				docStatus,
				linkSoppNo,
				linkMasterdocNo,
				docDesc,
				docFormNo,
				regDate,
				attrib
		) values (
				 #{docCrUserNo},
				 #{docAppLvl},
				 #{docType},
				 #{docTitle},
				 #{docStatus},
				 #{linkSoppNo},
				 #{linkMasterdocNo},
				 #{docDesc},
				 #{docFormNo},
				 now(),
				 '10000'
		 );
	</insert>

	<update id="updateDoc">
		update swc_businessdoc set
			docType = #{docType},
			docTitle = #{docTitle},
			docStatus = #{docStatus},
			linkSoppNo = #{linkSoppNo} ,
			linkMasterdocNo = #{linkMasterdocNo},
			docDesc = #{docDesc},
			docFormNo = #{docFormNo},
			ModDate = now()
		where docNo = #{docNo};
	</update>

	<update id="updateDocAppLvl">
		update swc_businessdoc set
			docAppLvl  = #{docAppLvl}
		where docNo = #{docNo};
	</update>

	<update id="deleteDoc">
		update swc_businessdoc set
			attrib = "XXXUP",
		    ModDate = now()
		where docNo = #{docNo};
	</update>

	<select id="listUserAtt" resultType="gwDto">

		select * from swc_userattend where compNo = #{compNo} and attrib not like 'XXX%';

	</select>

	<select id="detailUserAtt" resultType="gwDto">

		select * from swc_userattend where attendId = #{attendId};

	</select>

	<select id="listUserAttbyuser" resultType="gwDto">

		select * from swc_userattend where userNo = #{userNo} and attrib not like 'XXX%';

	</select>

	<insert id="insertUserAtt">

		insert into swc_userattend (
			compNo,
		    userNo,
			attType,
			attStart,
			attEnd,
			attTitle,
			attDesc,
			soppNo,
			regDate,
			attrib
		)
		values (
			#{compNo},
			#{userNo},
			#{attType},
			#{attStart},
			#{attEnd},
			#{attTitle},
			#{attDesc},
			#{soppNo},
			now(),
			'100001'
			   );
	</insert>

	<update id="updateUserAtt">
		update swc_userattend set
			  attType = #{attType},
			  attStart = #{attStart},
			  attEnd = #{attEnd},
			  attTitle = #{attTitle},
			  attDesc= #{attDesc},
			  soppNo = #{soppNo},
			  modDate = now()
			where attendId = #{attendId};
	</update>

	<update id="deleteUserAtt">

		update swc_userattend set
			modDate = now(),
		    attrib = 'XXXUP'
		where attendId = #{attendId};

	</update>



</mapper>