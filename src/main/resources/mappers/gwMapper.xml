<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="gw">

	<select id="listDoc" resultType="gwDto">
	    select a.*, b.userName from swc_businessdoc a left join swc_user b on a.docCrUserNo = b.userNo left join swc_businessdocapp c on a.docNo = c.docNo where a.attrib not like 'XXX%' and c.compNo = #{compNo} and a.docStatus != 1;
	</select>

    <select id="detailDoc" resultType="gwDto">
        select * from swc_businessdoc where attrib not like 'XXX%' and compNo = #{compNo} and docNo=#{docNo};
    </select>

    <insert id="insertest">
	    <selectKey resultType="int" keyProperty="estVer" order="BEFORE">
				select IFNULL(MAX(estVer), 0)+1 from swc_est where estId = #{estId} and compNo = #{compNo}
	 	</selectKey>
	    insert into swc_est(
	    	estId,
	    	estVer,
	    	estTitle,
	    	custNo,
	    	soppNo,
	    	compNo,
	    	userNo,
	    	estAmount,
	    	estVat,
	    	estTotal,
	    	estDate,
	    	attrib
	    ) values (
	    	#{estId},
	    	#{estVer},
	    	#{estTitle},
	    	#{custNo},
	    	#{soppNo},
	    	#{compNo},
	    	#{userNo},
	    	#{estAmount},
	    	#{estVat},
	    	#{estTotal},
	    	#{estDate},
	        '10000'
	    );
    </insert>

    <insert id="insertestitems">
    	<selectKey resultType="int" keyProperty="estVer" order="BEFORE">
				select IFNULL(MAX(estVer), 0)+1 from swc_estitems where estId = #{estId} and compNo = #{compNo}
	 	</selectKey>
	    insert into swc_estitems(
	    	estId,
	    	estVer,
	    	custNo,
	    	compNo,
	    	productNo,
	    	productName,
	    	productSpec,
	    	productQty,
	    	productNetprice,
	    	productVat,
	    	productAmount,
	    	productDis,
	    	productTotal,
	    	productRemark,
	    	attrib
	    ) values (
	    	#{estId},
	    	#{estVer},
	    	#{custNo},
	    	#{compNo},
	    	#{productNo},
	    	#{productName},
	    	#{productSpec},
	    	#{productQty},
	    	#{productNetprice},
	    	#{productVat},
	    	#{productAmount},
	    	#{productDis},
	    	#{productTotal},
	    	#{productRemark},
	        '10000'
	    );
    </insert>

	<select id="listest" resultType="gwDto">
		select
			a.estNo
			 ,a.estId
			 ,max(a.estVer) estVer
			 ,a.estType
			 ,a.estTitle
			 ,a.estDesc
			 ,a.custNo
			 ,b.custName
			 ,a.soppNo
			 ,a.compNo
			 ,a.userNo
			 ,a.estAmount
			 ,a.estVat
			 ,a.estDiscount
			 ,a.estTotal
			 ,a.estDate
			 ,a.regDate
			 ,a.modDate
			 ,a.attrib
		from swc_est a
				 left join swc_cust b on a.custNo = b.custNo
		where a.compNo = #{compNo} and a.attrib not like 'XXX%' group by a.estId;
	</select>

	<select id="detailest" resultType="gwDto">
		select a.*, b.custName, c.soppTitle from swc_est a LEFT JOIN swc_cust b ON a.custNo = b.custNo LEFT JOIN swc_sopp c ON a.soppNo = c.soppNo where a.estId=#{estId} limit 1;
	</select>

	<select id="listestitems" resultType="gwDto">
		select a.*, b.custName from swc_estitems a LEFT JOIN swc_cust b ON a.custNo = b.custNo where a.estId=#{estId} and a.estVer = #{estVer} and a.attrib not like 'XXX%';
	</select>

	<select id="myList" resultType="gwDto">
		select a.*, b.appStatus from swc_businessdoc a left join swc_businessdocapp b on a.docNo = b.docNo where a.attrib not like 'XXX%' and a.docCrUserNo = #{docCrUserNo};
	</select>
	
	<select id="myDocList" resultType="gwDto">
		select a.*, c.userName as userIsName, b.appStatus from swc_businessdoc a left join swc_businessdocapp b on a.docNo = b.docNo left join swc_user c on c.userNo = b.userNoIS where b.userNoAPP = #{userNo} and a.docStatus = 2 and b.appStatus = 2 or b.appStatus = 4;
	</select>

	<insert id="insertDoc" useGeneratedKeys="true" keyProperty="getId">
		<selectKey keyProperty="getId" resultType="int" order="AFTER">
	        SELECT max(docNo) from swc_businessdoc
	    </selectKey>
		insert into swc_businessdoc (
			compNo,
			docCrUserNo,
			docAppLvl,
			docType,
			docTitle,
			docStatus,
			linkSoppNo,
			linkMasterdocNo,
			docDesc,
			docFormNo,
			docAmount,
			docDate
			regDate,
			attrib
		) values (
			#{compNo},
		 	#{docCrUserNo},
		 	#{docAppLvl},
		 	#{docType},
		 	#{docTitle},
		 	#{docStatus},
		 	#{linkSoppNo},
		 	#{linkMasterdocNo},
		 	#{docDesc},
		 	#{docFormNo},
		 	#{docAmount},
		 	#{docDate},
		 	now(),
		 	'10000'
	 	);
	</insert>
	
	<insert id="insertDocApp">
		insert into swc_businessdocapp (
			compNo,
			docNo,
			userNoCR,
			userNoIS,
			userNoAPP,
			appStatus,
			regDate,
			attrib
		) values (
		 	#{compNo},
		 	#{docNo},
		 	#{userNoCR},
		 	#{userNoIS},
		 	#{userNoAPP},
		 	#{appStatus},
		 	now(),
		 	'10000'
	 	);
	</insert>
	
	<insert id="insertDocData">
		insert into swc_businessdocdata (
			docNo,
			custName,
			productName,
			productNetprice,
			productQty,
			productAmount,
			productVat,
			productTotal,
			productRemark,
			regDate,
			attrib
		) values (
		 	#{docNo},
		 	#{custName},
		 	#{productName},
		 	#{productNetprice},
		 	#{productQty},
		 	#{productAmount},
		 	#{productVat},
		 	#{productTotal},
		 	#{productRemark},
		 	now(),
		 	'10000'
	 	);
	</insert>

	<update id="updateDoc">
		update swc_businessdoc set
			docType = #{docType},
			docTitle = #{docTitle},
			docStatus = #{docStatus},
			linkSoppNo = #{linkSoppNo} ,
			linkMasterdocNo = #{linkMasterdocNo},
			docDesc = #{docDesc},
			docFormNo = #{docFormNo},
			ModDate = now()
		where docNo = #{docNo};
	</update>

	<update id="updateDocAppLvl">
		update swc_businessdoc set
			docAppLvl  = #{docAppLvl}
		where docNo = #{docNo};
	</update>

	<update id="deleteDoc">
		update swc_businessdoc set
			attrib = "XXXUP",
		    ModDate = now()
		where docNo = #{docNo};
	</update>

	<select id="listUserAtt" resultType="gwDto">

		select * from swc_userattend where compNo = #{compNo} and attrib not like 'XXX%';

	</select>

	<select id="detailUserAtt" resultType="gwDto">

		select * from swc_userattend where attendId = #{attendId};

	</select>

	<select id="listUserAttbyuser" resultType="gwDto">

		select * from swc_userattend where userNo = #{userNo} and attrib not like 'XXX%';

	</select>

	<insert id="insertUserAtt">
		insert into swc_userattend (
			compNo,
		    userNo,
			attType,
			attStart,
			attEnd,
			attTitle,
			attDesc,
			soppNo,
			regDate,
			attrib
		)
		values (
			#{compNo},
			#{userNo},
			#{attType},
			#{attStart},
			#{attEnd},
			#{attTitle},
			#{attDesc},
			#{soppNo},
			now(),
			'100001'
		);
	</insert>

	<update id="updateUserAtt">
		update swc_userattend set
			  attType = #{attType},
			  attStart = #{attStart},
			  attEnd = #{attEnd},
			  attTitle = #{attTitle},
			  attDesc= #{attDesc},
			  soppNo = #{soppNo},
			  modDate = now()
			where attendId = #{attendId};
	</update>

	<update id="deleteUserAtt">

		update swc_userattend set
			modDate = now(),
		    attrib = 'XXXUP'
		where attendId = #{attendId};

	</update>

	<select id="listdocApp" resultType="gwDto">
		select * from swc_businessdocapp where attrib not like 'XXX%' and docNo = #{docNo};
	</select>

	<select id="listmyAppdoc" resultType="gwDto">
		select * from swc_businessdocapp where attrib not like 'XXX%' and userNoAPP = ${userNo} and appDate is null ;
	</select>

	<insert id="insAppline">
		insert into swc_businessdocapp
		( 
		compNo,
		docNo,
		appLine,
		userNoCR,
		userNoIS,
		userNoAPP,
		appStatus,
		issueDate,
		regDate,
		attrib ) 
		values 
		( 
		#{compNo},
		#{docNo},
		#{appLine},
		#{userNoCR},
		#{userNoIS},
		#{userNoAPP},
		#{appStatus},
		#{issueDate},
		now(),
		'100001'  
		);
	</insert>

	<update id="updApp">
		update swc_businessdocapp set
			appDate = now(),
		    appComment = #{appComment},
		    appStatus = #{appStatus},
		    modDate = now()
		where appId = #{appId};
	</update>

</mapper>